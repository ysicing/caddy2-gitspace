# 功能规格：Caddy v2 Kubernetes Deployment 动态路由扩展

**功能分支**：`001-caddy-v2-watch`
**创建日期**：2025-11-04
**状态**：草稿
**输入**：用户描述："想实现一个caddy v2版本的扩展，watch k8s某个命名空间一下deploy的创建，当deploy创建成功后，根据deploy的类型自动创建一个路由。举例如果是vscode，deploy名是vscode，注解里有端口8080，caddy自动将deploy.example转发给对应的podip，当deploy销毁或者副本为0默认移除这个"

## 执行流程（main）
```
1. 从输入解析用户描述
   → 功能描述清晰：Caddy v2 扩展监听 K8s Deployment 并自动管理路由
2. 从描述中提取关键概念
   → 参与者：Caddy v2 扩展、Kubernetes Deployment、Pod
   → 操作：监听、创建路由、删除路由
   → 数据：命名空间、Deployment 名称、注解端口、域名
   → 约束：副本为 0 或 Deployment 删除时移除路由
3. 对于每个不清晰的方面：
   → [需要澄清：域名模式 - deploy.example 的 example 是固定域名还是可配置？]
   → [需要澄清：多个 Pod 副本时的负载均衡策略]
   → [需要澄清：注解的具体格式和命名规范]
   → [需要澄清：Caddy 配置重载机制]
   → [需要澄清：失败重试和错误处理策略]
4. 填充用户场景与测试部分
   → 用户流程清晰：创建 Deployment → 自动路由 → 删除/缩容 → 移除路由
5. 生成功能需求
   → 所有核心需求可测试
6. 识别关键实体
   → Deployment、Pod、路由配置、注解
7. 运行审查清单
   → 警告：规格存在不确定性（域名配置、负载均衡策略等）
8. 返回：规格已准备好进行澄清和规划
```

---

## ⚡ 快速指南
- ✅ 专注于用户需要什么和为什么
- ❌ 避免如何实现（不涉及技术栈、API、代码结构）
- 👥 为业务利益相关者而非开发人员编写

### 章节要求
- **必填章节**：每个功能都必须完成
- **可选章节**：仅在与功能相关时包含
- 当某个章节不适用时，完全移除（不要保留为"不适用"）

### AI 生成指南
从用户提示创建此规格时：
1. **标记所有歧义**：对于需要做出假设的任何内容，使用 [需要澄清：具体问题]
2. **不要猜测**：如果提示未指定某些内容（例如，未指定认证方法的"登录系统"），请标记它
3. **像测试人员一样思考**：每个模糊的需求都应该未通过"可测试且明确"的清单项
4. **常见未充分说明的领域**：
   - 用户类型和权限
   - 数据保留/删除策略
   - 性能目标和规模
   - 错误处理行为
   - 集成需求
   - 安全/合规需求

---

## 澄清

### 会话 2025-11-04
- 问：基础域名如何配置？ → 答：通过 Caddy 配置文件指定基础域名
- 问：Deployment 注解的键名格式是什么？ → 答：gitspace.caddy.default.port: "8080"
- 问：多个 Pod 副本时使用什么负载均衡策略？ → 答：所有 Deployment 都是单副本
- 问：当 Deployment 缺少端口注解时，系统应该如何处理？ → 答：使用默认端口 8089
- 问：只对就绪(Ready)的 Pod 创建路由，还是所有 Pod 都创建？ → 答：只对就绪的 Pod 创建路由，并将域名信息以注解方式写回 Deployment

---

## 用户场景与测试 *（必填）*

### 主要用户故事
作为一个 Kubernetes 集群管理员，我希望当开发团队在特定命名空间中部署应用时，Caddy 能够自动创建对应的 HTTP 路由，使得应用可以通过友好的域名访问，而不需要手动配置反向代理规则。当应用被删除或缩容至 0 时，相应的路由应该自动清理，保持 Caddy 配置的整洁。

### 验收场景

**场景 1：创建 Deployment 并自动生成路由**
1. **假定** Kubernetes 集群中监控的命名空间为空，**当** 用户创建一个名为 "vscode" 的 Deployment，并在注解中指定端口为 8080，**那么** Caddy 自动创建一个从 "vscode.example" 到该 Pod IP:8080 的路由

**场景 2：Deployment 扩容时的路由行为**
2. **假定** 已存在一个 Deployment "vscode" 及其路由，**当** 用户将副本数从 1 扩展到 3，**那么** 路由应该能够将流量分发到所有健康的 Pod

**场景 3：Deployment 缩容至 0 时移除路由**
3. **假定** 存在一个运行中的 Deployment "vscode" 及其路由，**当** 用户将副本数缩减到 0，**那么** Caddy 自动移除 "vscode.example" 的路由配置

**场景 4：删除 Deployment 时清理路由**
4. **假定** 存在一个运行中的 Deployment "vscode" 及其路由，**当** 用户删除该 Deployment，**那么** Caddy 自动移除 "vscode.example" 的路由配置

**场景 5：多个不同类型的 Deployment**
5. **假定** 命名空间中已有 "vscode" Deployment，**当** 用户创建新的 "jupyter" Deployment 并指定端口 8888，**那么** Caddy 同时维护 "vscode.example" 和 "jupyter.example" 两个独立路由

### 边缘情况
- 当 Deployment 的 Pod 还未就绪时，路由应该如何处理？
  - 系统只为就绪的 Pod 创建路由，未就绪的 Pod 不创建路由
- 系统如何处理同名 Deployment 在不同命名空间中的情况？
  - 由于只监听单个命名空间，不会出现冲突
- 当注解中缺少端口信息时会发生什么？
  - 系统使用默认端口 8089 创建路由
- 当 Pod IP 变化（如 Pod 重启）时，路由如何更新？
  - 系统监听 Pod 事件，动态更新路由配置
- 当 Caddy 扩展本身重启时，如何恢复路由配置？
  - 系统启动时重新同步命名空间中所有符合条件的 Deployment
- 当路由创建成功后，如何通知用户？
  - 系统将生成的域名信息以注解方式写回 Deployment

## 需求 *（必填）*

### 功能需求

**核心监听功能**
- **FR-001**：系统必须能够监听指定 Kubernetes 命名空间中的 Deployment 资源变化
- **FR-002**：系统必须能够检测 Deployment 的创建、更新和删除事件
- **FR-003**：系统必须能够监听 Deployment 副本数的变化

**路由创建与管理**
- **FR-004**：系统必须在 Deployment 创建成功且 Pod 就绪后，自动为其创建对应的 HTTP 路由
- **FR-005**：系统必须从 Deployment 的注解 `gitspace.caddy.default.port` 中读取目标端口信息
- **FR-006**：系统必须根据 Deployment 名称和 Caddy 配置文件中指定的基础域名生成路由域名（格式：{deployment-name}.{base-domain}）
- **FR-007**：系统必须将路由流量转发到对应 Pod 的 IP 地址和指定端口
- **FR-008**：系统必须在 Deployment 被删除时，自动移除对应的路由配置
- **FR-009**：系统必须在 Deployment 副本数缩减至 0 时，自动移除对应的路由配置
- **FR-010**：系统必须在路由创建成功后，将生成的域名信息以注解方式写回 Deployment

**副本与 Pod 管理**
- **FR-011**：系统假设所有 Deployment 都是单副本，不需要处理多副本负载均衡
- **FR-012**：系统必须能够动态更新路由以反映 Pod IP 的变化（如 Pod 重启）
- **FR-013**：系统必须只为就绪状态的 Pod 创建路由

**配置与注解**
- **FR-014**：系统必须支持通过 Deployment 注解 `gitspace.caddy.default.port` 指定目标端口
- **FR-015**：系统必须在 Deployment 缺少端口注解时，使用默认端口 8089
- **FR-016**：系统必须支持通过 Caddy 配置文件指定基础域名
- **FR-017**：系统必须支持通过配置指定要监听的命名空间（单个命名空间）

**错误处理与可靠性**
- **FR-018**：系统必须在无法连接到 Kubernetes API 时记录错误
- **FR-019**：系统必须能够在 Caddy 扩展重启后重新同步所有路由配置
- **FR-020**：系统必须验证从注解中读取的端口号有效性（范围 1-65535）

**状态反馈**
- **FR-021**：系统必须提供扩展的健康状态接口用于监控

### 关键实体 *（如果功能涉及数据则包含）*

- **Deployment**：Kubernetes 部署资源，包含应用的副本配置和元数据
  - 关键属性：名称、命名空间、副本数（固定为 1）、注解（gitspace.caddy.default.port）、标签
  - 关系：拥有一个 Pod（单副本）

- **Pod**：Kubernetes 中运行的容器实例
  - 关键属性：IP 地址、就绪状态、所属 Deployment
  - 关系：属于某个 Deployment，是路由的实际目标（只有就绪的 Pod 才会被路由）

- **路由配置**：Caddy 中的反向代理规则
  - 关键属性：源域名（{deployment-name}.{base-domain}）、目标地址（Pod IP + 端口）、关联的 Deployment 名称
  - 关系：与 Deployment 一对一关联

- **注解**：Deployment 上的元数据键值对
  - 关键属性：
    - 输入注解：`gitspace.caddy.default.port`（端口号，可选，默认 8089）
    - 输出注解：路由创建成功后写回的域名信息
  - 关系：属于 Deployment，用于配置路由行为和反馈路由状态

- **Caddy 配置**：Caddy 配置文件中的设置
  - 关键属性：基础域名、监听的命名空间
  - 关系：全局配置，影响所有路由的域名生成

---

## 审查与验收清单
*门禁：在 main() 执行期间运行的自动检查*

### 内容质量
- [x] 没有实现细节（语言、框架、API）
- [x] 专注于用户价值和业务需求
- [x] 为非技术利益相关者编写
- [x] 所有必填章节已完成

### 需求完整性
- [x] 没有剩余的 [需要澄清] 标记
- [x] 需求可测试且明确
- [x] 成功标准可衡量
- [x] 范围明确界定
- [x] 已识别依赖关系和假设

---

## 执行状态
*由 main() 在处理过程中更新*

- [x] 用户描述已解析
- [x] 关键概念已提取
- [x] 歧义已标记并解决（5 个关键澄清点已完成）
- [x] 用户场景已定义
- [x] 需求已生成（21 个功能需求）
- [x] 实体已识别（5 个关键实体）
- [x] 审查清单已通过

---

## 下一步
本规格已完成澄清阶段，所有关键歧义已解决：

**已澄清的决策**：
1. ✅ 基础域名通过 Caddy 配置文件指定
2. ✅ 注解键名：gitspace.caddy.default.port
3. ✅ 所有 Deployment 都是单副本
4. ✅ 缺少端口注解时使用默认端口 8089
5. ✅ 只对就绪的 Pod 创建路由，并将域名信息写回 Deployment

**规格状态**：准备进入实施规划阶段

建议使用 `/spec-kit:plan` 命令进入实施规划阶段，生成详细的设计文档和任务分解。