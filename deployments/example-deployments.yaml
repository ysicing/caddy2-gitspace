# Caddy2-k8s 示例 Deployment 配置
#
# 本文件演示如何配置 Deployment 以便 Caddy 自动创建路由
#
# Label 筛选说明：
# ----------------
# Caddy2-k8s 只监控带有以下标签的 Deployment：
#   gitspace.app.io/managed-by: caddy
#
# 这是硬编码的筛选规则，不可配置。
#
# 推荐做法：
# ----------
# 1. 在 metadata.labels 中添加 gitspace.app.io/managed-by: caddy
# 2. 同时在 spec.template.metadata.labels 中添加相同标签（Pod 继承）
# 3. 只有带此标签的 Deployment 才会被自动管理路由

---
# 示例 1：VSCode Deployment（使用自定义端口）
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vscode
  namespace: default
  labels:
    # 必需：此标签是强制性的，Caddy 只监控带此标签的 Deployment
    gitspace.app.io/managed-by: caddy
  annotations:
    # 指定端口（Caddy 会将流量转发到 Pod 的 8080 端口）
    gitspace.caddy.default.port: "8080"
spec:
  replicas: 1  # 必须是 1（插件仅支持单副本）
  selector:
    matchLabels:
      app: vscode
  template:
    metadata:
      labels:
        app: vscode
        gitspace.app.io/managed-by: caddy
    spec:
      containers:
        - name: vscode
          image: codercom/code-server:latest
          ports:
            - containerPort: 8080
          env:
            - name: PASSWORD
              value: "your-password"

---
# 示例 2：Jupyter Deployment（使用默认端口 8089）
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jupyter
  namespace: default
  labels:
    gitspace.app.io/managed-by: caddy
  # 没有指定端口注解，将使用默认端口 8089
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jupyter
  template:
    metadata:
      labels:
        app: jupyter
        gitspace.app.io/managed-by: caddy
    spec:
      containers:
        - name: jupyter
          image: jupyter/scipy-notebook:latest
          ports:
            - containerPort: 8089
          env:
            - name: JUPYTER_ENABLE_LAB
              value: "yes"

---
# 示例 3：Web 应用 Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
  namespace: default
  labels:
    gitspace.app.io/managed-by: caddy
  annotations:
    gitspace.caddy.default.port: "3000"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
        gitspace.app.io/managed-by: caddy
    spec:
      containers:
        - name: app
          image: your-app:latest
          ports:
            - containerPort: 3000

---
# 示例 4：不被管理的 Deployment（没有指定 Label）
apiVersion: apps/v1
kind: Deployment
metadata:
  name: unmanaged-app
  namespace: default
  # 注意：没有 gitspace.app.io/managed-by: caddy 标签
  # 此 Deployment 不会被 Caddy 监控和管理
spec:
  replicas: 1
  selector:
    matchLabels:
      app: unmanaged
  template:
    metadata:
      labels:
        app: unmanaged
    spec:
      containers:
        - name: app
          image: nginx:latest
          ports:
            - containerPort: 80
